<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>建設業従業員評価管理システム</title>
    <!-- Bootstrap and Font Awesome for UI components and icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <!-- Custom Stylesheet -->
    <style>
        /* General Body Styles */
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #212529;
        }
        /* Layout */
        #app { display: flex; flex-direction: column; height: 100vh; }
        #header-container { position: fixed; top: 0; left: 0; right: 0; z-index: 1030; }
        .main-layout { display: flex; flex-grow: 1; margin-top: 56px; height: calc(100vh - 56px); }
        #sidebar-container { flex-shrink: 0; width: 250px; height: 100%; transition: transform 0.3s ease-in-out; z-index: 1020; }
        #content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }

        /* Sidebar Styles */
        .sidebar {
            height: 100%;
            background-color: #212529;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            transition: all 0.2s ease;
            border-radius: 0.3rem;
            padding: 0.75rem 1rem;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }
        .sidebar .nav-link.active {
            background: #0d6efd;
            color: #fff;
        }
        /* Other UI Enhancements */
        .card { border: none; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .table-responsive { overflow-x: auto; }
        .table { white-space: nowrap; }

        /* Responsive */
        @media (max-width: 991.98px) {
            #sidebar-container {
                position: fixed;
                transform: translateX(-100%);
                background-color: #212529;
            }
            #sidebar-container.show {
                transform: translateX(0);
            }
            #content {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading screen shown during initial app load -->
    <div id="loading-screen" class="d-flex justify-content-center align-items-center vh-100">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Main application container, hidden by default -->
    <div id="app" class="d-none">
        <div id="header-container"></div>
        <div class="main-layout">
            <div id="sidebar-container"></div>
            <main id="content"></main>
        </div>
        <!-- Container for toast notifications -->
        <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
    </div>

    <!-- Bootstrap JS Bundle for interactive components like modals and dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- All JavaScript code is now inlined here to prevent module resolution errors -->
    <script type="module">
        // --- Firebase SDK Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut as firebaseSignOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAK3wAWIZCultkSQfyse8L8Z-JNMEVK5Wk",
            authDomain: "hyouka-db.firebaseapp.com",
            projectId: "hyouka-db",
            storageBucket: "hyouka-db.appspot.com",
            messagingSenderId: "861016804589",
            appId: "1:861016804589:web:d911d516d6c79aa73690e4"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        window.firebase = {
            app: firebaseApp,
            auth: getAuth(firebaseApp),
            db: getFirestore(firebaseApp),
            functions: getFunctions(firebaseApp)
        };

        // --- Inlined Translation Data ---
        const translationsData = {
            ja: {
                "nav": { "dashboard": "ダッシュボード", "users": "ユーザー管理", "evaluations": "評価一覧", "logout": "ログアウト" },
                "auth": { "login": "ログイン", "email": "メールアドレス", "password": "パスワード" },
                "errors": { "invalid_email_password": "メールアドレスまたはパスワードが正しくありません。" }
                // ... Add all other Japanese translations here
            },
            en: {
                "nav": { "dashboard": "Dashboard", "users": "User Management", "evaluations": "Evaluations", "logout": "Logout" },
                "auth": { "login": "Login", "email": "Email Address", "password": "Password" },
                "errors": { "invalid_email_password": "Incorrect email or password." }
                // ... Add all other English translations here
            },
            vi: {
                "nav": { "dashboard": "Bảng điều khiển", "users": "Quản lý người dùng", "evaluations": "Đánh giá", "logout": "Đăng xuất" },
                "auth": { "login": "Đăng nhập", "email": "Địa chỉ email", "password": "Mật khẩu" },
                "errors": { "invalid_email_password": "Sai email hoặc mật khẩu." }
                // ... Add all other Vietnamese translations here
            }
        };

        // --- I18n Service (Modified) ---
        class I18n {
            constructor() { this.lang = "ja"; this.translations = {}; this.supportedLanguages = ["ja", "en", "vi"]; }
            async init() { await this.setLanguage(localStorage.getItem("lang") || this.lang); }
            async setLanguage(lang) { this.lang = this.supportedLanguages.includes(lang) ? lang : "ja"; localStorage.setItem("lang", this.lang); this.loadTranslations(this.lang); this.updateUI(); }
            loadTranslations(lang) { this.translations = translationsData[lang] || translationsData.ja; }
            t(key, params = {}) { let translation = key.split('.').reduce((obj, k) => obj && obj[k], this.translations); if (translation) { for (const param in params) { translation = translation.replace(new RegExp(`{{${param}}}`, 'g'), params[param]); } } return translation || key; }
            updateUI(element = document) { element.querySelectorAll("[data-i18n]").forEach(el => { const key = el.getAttribute("data-i18n"); const params = JSON.parse(el.getAttribute("data-i18n-params") || "{}"); el.textContent = this.t(key, params); }); element.querySelectorAll("[data-i18n-placeholder]").forEach(el => { const key = el.getAttribute("data-i18n-placeholder"); el.placeholder = this.t(key); }); }
        }

        // --- Auth Service ---
        class Auth {
            constructor(app) { this.app = app; this.auth = window.firebase.auth; this.db = window.firebase.db; }
            init() { return new Promise((resolve) => { onAuthStateChanged(this.auth, async (user) => { if (user) { try { const userProfile = await this.getUserProfile(user.uid); this.app.currentUser = userProfile ? { ...user, ...userProfile } : user; } catch (error) { console.error("Error fetching user profile:", error); this.app.currentUser = null; await this.logout(); } } else { this.app.currentUser = null; } resolve(); }); }); }
            async getUserProfile(uid) { const userDocRef = doc(this.db, "users", uid); const userDocSnap = await getDoc(userDocRef); return userDocSnap.exists() ? userDocSnap.data() : null; }
            async login(email, password) { await signInWithEmailAndPassword(this.auth, email, password); }
            async logout() { await firebaseSignOut(this.auth); }
        }

        // --- API Service ---
        class API {
            constructor(app) { this.app = app; this.db = window.firebase.db; }
            async getUsers() { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "users"), where("tenantId", "==", this.app.currentUser.tenantId)); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })); }
        }

        // --- Component Classes ---
        class HeaderComponent {
            constructor(app) { this.app = app; }
            update() {
                const container = document.getElementById('header-container');
                if (!this.app.isAuthenticated()) { container.innerHTML = ''; return; }
                container.innerHTML = `<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#/dashboard" data-link>評価システム</a>
                        <div class="collapse navbar-collapse">
                            <ul class="navbar-nav me-auto">
                                <li class="nav-item"><a class="nav-link" href="#/dashboard" data-link>ダッシュボード</a></li>
                                <li class="nav-item"><a class="nav-link" href="#/users" data-link>ユーザー管理</a></li>
                            </ul>
                            <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); window.app.logout();">ログアウト</a></li></ul>
                        </div>
                    </div>
                </nav>`;
            }
        }
        class SidebarComponent {
            constructor(app) { this.app = app; }
            update() {
                const container = document.getElementById('sidebar-container');
                if (!this.app.isAuthenticated()) { container.innerHTML = ''; return; }
                container.innerHTML = `<div class="sidebar bg-dark text-white p-3 d-flex flex-column">
                    <nav class="nav flex-column">
                        <a class="nav-link text-white" href="#/dashboard" data-link>ダッシュボード</a>
                        <a class="nav-link text-white" href="#/evaluations" data-link>評価一覧</a>
                    </nav>
                </div>`;
            }
        }

        // --- Page Classes (Placeholders for now) ---
        class LoginPage { constructor(app) {this.app = app;} async render() { return `<div class="d-flex align-items-center justify-content-center vh-100"><div class="card p-4" style="width: 400px;"><h3>ログイン</h3><form id="loginForm"><div class="mb-3"><label>Email</label><input type="email" id="email" class="form-control" required></div><div class="mb-3"><label>Password</label><input type="password" id="password" class="form-control" required></div><button type="submit" class="btn btn-primary w-100">ログイン</button></form></div></div>`; } async init() { document.getElementById('loginForm').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; await this.app.login(email, password); }); } }
        class DashboardPage { constructor(app) {this.app = app;} async render() { return `<h1>ダッシュボード</h1><p>ようこそ、${this.app.currentUser.name || this.app.currentUser.email}さん</p>`; } }
        class UserManagementPage { constructor(app) {this.app = app;} async render() { return `<h1>ユーザー管理</h1>`; } }
        class EvaluationsPage { constructor(app) {this.app = app;} async render() { return `<h1>評価一覧</h1>`; } }
        // ... other page classes would be defined here fully
        
        // --- Router Service (Modified for Hash Routing) ---
        class Router {
            constructor(app) {
              this.app = app;
              this.routes = { "/": LoginPage, "/login": LoginPage, "/dashboard": DashboardPage, "/users": UserManagementPage, "/evaluations": EvaluationsPage };
            }
            async route() {
                const path = window.location.hash.substring(1) || "/";
                const PageClass = this.routes[path] || LoginPage; // Default to LoginPage
                const requiresAuth = !["/", "/login", "/register"].includes(path);

                if (requiresAuth && !this.app.isAuthenticated()) { window.location.hash = "/login"; return; }
                if (!requiresAuth && this.app.isAuthenticated()) { window.location.hash = "/dashboard"; return; }
                
                this.app.header.update();
                this.app.sidebar.update();

                const pageInstance = new PageClass(this.app);
                this.app.currentPage = pageInstance;
                const contentContainer = document.getElementById("content");
                contentContainer.innerHTML = await pageInstance.render();
                if (typeof pageInstance.init === "function") await pageInstance.init();
            }
        }

        // --- Main App Class (Modified for Hash Routing) ---
        class App {
            constructor() {
                this.currentUser = null;
                this.i18n = new I18n();
                this.auth = new Auth(this);
                this.api = new API(this);
                this.header = new HeaderComponent(this);
                this.sidebar = new SidebarComponent(this);
                this.router = new Router(this);
            }
            async init() {
                try {
                    await this.auth.init();
                    this.setupEventListeners();
                    await this.router.route();
                    this.showApp();
                } catch (error) {
                    console.error("App Init Failed:", error);
                }
            }
            setupEventListeners() {
                window.addEventListener("hashchange", () => this.router.route());
            }
            navigate(path) { window.location.hash = path; }
            showApp() { document.getElementById("loading-screen").style.display = "none"; document.getElementById("app").classList.remove("d-none"); }
            isAuthenticated() { return !!this.currentUser; }
            async login(email, password) { try { await this.auth.login(email, password); } catch (e) { console.error(e); throw e; } }
            async logout() { await this.auth.logout(); }
        }

        // --- Start the App ---
        window.app = new App();
        window.app.init();
    </script>
</body>
</html>
