<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>建設業従業員評価管理システム</title>
    <!-- Bootstrap and Font Awesome for UI components and icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <!-- Custom Stylesheet -->
    <style>
        /* General Body Styles */
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #212529;
        }
        /* Layout */
        #app { display: flex; flex-direction: column; height: 100vh; }
        #header-container { position: fixed; top: 0; left: 0; right: 0; z-index: 1030; }
        .main-layout { display: flex; flex-grow: 1; margin-top: 56px; height: calc(100vh - 56px); }
        #sidebar-container { flex-shrink: 0; width: 250px; height: 100%; transition: transform 0.3s ease-in-out; z-index: 1020; }
        #content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }

        /* Sidebar Styles */
        .sidebar {
            height: 100%;
            background-color: #212529;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            transition: all 0.2s ease;
            border-radius: 0.3rem;
            padding: 0.75rem 1rem;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }
        .sidebar .nav-link.active {
            background: #0d6efd;
            color: #fff;
        }
        /* Other UI Enhancements */
        .card { border: none; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .table-responsive { overflow-x: auto; }
        .table { white-space: nowrap; }
        .settings-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; }

        /* Responsive */
        @media (max-width: 991.98px) {
            #sidebar-container {
                position: fixed;
                transform: translateX(-100%);
                background-color: #212529;
            }
            #sidebar-container.show {
                transform: translateX(0);
            }
            #content {
                width: 100%;
            }
            .navbar-toggler {
                display: block !important;
            }
            .settings-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading screen shown during initial app load -->
    <div id="loading-screen" class="d-flex justify-content-center align-items-center vh-100">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Main application container, hidden by default -->
    <div id="app" class="d-none">
        <div id="header-container"></div>
        <div class="main-layout">
            <div id="sidebar-container"></div>
            <main id="content"></main>
        </div>
        <!-- Container for toast notifications -->
        <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
    </div>

    <!-- Bootstrap JS Bundle for interactive components like modals and dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- All JavaScript code is now inlined here to prevent module resolution errors -->
    <script type="module">
        // --- Firebase SDK Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut as firebaseSignOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp, writeBatch,getCountFromServer } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAK3wAWIZCultkSQfyse8L8Z-JNMEVK5Wk",
            authDomain: "hyouka-db.firebaseapp.com",
            projectId: "hyouka-db",
            storageBucket: "hyouka-db.appspot.com",
            messagingSenderId: "861016804589",
            appId: "1:861016804589:web:d911d516d6c79aa73690e4"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        window.firebase = {
            app: firebaseApp,
            auth: getAuth(firebaseApp),
            db: getFirestore(firebaseApp),
            functions: getFunctions(firebaseApp)
        };

        // --- Inlined Translation Data ---
        const translationsData = {
            ja: {
                "common": { "save": "保存", "cancel": "キャンセル", "delete": "削除", "edit": "編集", "add": "追加", "search": "検索", "loading": "読み込み中...", "error": "エラー", "success": "成功", "confirm": "確認", "yes": "はい", "no": "いいえ", "close": "閉じる", "submit": "送信", "reset": "リセット", "back": "戻る", "next": "次へ", "previous": "前へ", "select": "選択してください", "clear": "クリア", "toggle_navigation": "ナビゲーション切り替え", "language": "言語", "no_data": "データがありません", "details": "詳細", "all": "全て" },
                "nav": { "dashboard": "ダッシュボード", "users": "ユーザー管理", "settings": "設定", "evaluations": "評価一覧", "goals": "目標設定", "goal_approvals": "目標承認", "reports": "レポート", "developer": "開発者ツール", "logout": "ログアウト", "profile": "プロフィール", "evaluation": "評価入力" },
                "auth": { "login": "ログイン", "logout": "ログアウト", "email": "メールアドレス", "password": "パスワード", "name": "氏名", "company": "企業名", "register": "登録", "login_failed": "ログインに失敗しました", "register_success": "登録が完了しました", "forgot_password": "パスワードを忘れた方", "reset_password": "パスワードリセット", "confirm_password": "パスワード確認", "register_admin": "管理者登録申請", "register_user": "ユーザー登録" },
                "dashboard": { "welcome": "ようこそ", "total_users": "総ユーザー数", "completed_evaluations": "完了済み評価", "pending_evaluations": "未完了の評価", "evaluation_overview": "評価概要" },
                "developer": { "title": "開発者ツール", "admin_approvals": "管理者アカウントの承認", "approve": "承認", "confirm_approve": "この管理者を承認しますか？", "approve_success": "管理者を承認しました。" },
                "evaluations": { "title": "評価一覧", "new_evaluation": "新規評価", "period": "評価期間", "target_user": "対象者", "evaluator": "評価者", "total_score": "総合スコア", "form_title": "評価入力", "target_info": "評価対象情報", "select_target_user": "評価対象者を選択", "select_period": "評価期間を選択", "job_type": "職種", "confirm_submit": "評価を提出しますか？提出後は編集できません。" },
                "goals": { "title": "目標設定", "approvals_title": "目標承認", "add_goal": "目標を追加", "weight": "ウェイト", "total_weight": "合計ウェイト", "apply": "申請", "approve": "承認", "reject": "差し戻し", "pending_goals": "承認待ちの目標", "approved_goals": "承認済みの目標", "confirm_approve": "この目標を承認しますか？", "confirm_reject": "この目標を差し戻しますか？", "approve_success": "目標を承認しました。", "reject_success": "目標を差し戻しました。" },
                "reports": { "title": "評価レポート", "comparison": "過去の評価と比較", "select_comparison": "比較対象を選択...", "self_assessment": "自己評価", "evaluator_assessment": "評価者評価", "score": "スコア", "comment": "コメント", "no_past_evaluations": "比較可能な過去の評価はありません。" },
                "settings": { "title": "設定", "job_types": "対象職種", "evaluation_periods": "評価期間", "evaluation_structure": "評価構造", "add_job_type": "職種を追加", "add_period": "期間を追加", "job_type_name": "職種名", "period_name": "期間名", "start_date": "開始日", "end_date": "終了日", "add_category": "カテゴリを追加", "add_item": "項目を追加", "item_type": "項目種別", "quantitative": "定量的", "qualitative": "定性的", "save_changes": "変更を保存", "unsaved_warning": "未保存の変更があります。ページを離れてもよろしいですか？" },
                "users": { "title": "ユーザー管理", "invite": "新規ユーザー追加", "role": "役割", "status": "ステータス", "created_at": "登録日", "actions": "操作", "pending_approvals": "承認待ちユーザー", "active_users": "アクティブユーザー", "confirm_approve": "このユーザーを承認しますか？", "approve_success": "ユーザーを承認しました。", "confirm_reject": "このユーザーを否認（削除）しますか？", "reject_success": "ユーザーを否認・削除しました。" },
                "roles": { "developer": "開発者", "admin": "管理者", "evaluator": "評価者", "worker": "作業員" },
                "status": { "active": "アクティブ", "developer_approval_pending": "開発者承認待ち", "pending_approval": "承認待ち", "inactive": "無効", "completed": "完了", "self_assessed": "自己評価完了", "approved_by_evaluator": "評価者承認済み", "rejected": "差し戻し", "draft": "下書き" },
                "messages": { "login_success": "ようこそ、{{userName}}さん", "logout_success": "ログアウトしました。", "save_success": "保存しました。", "register_admin_success": "管理者アカウントの申請が完了しました。開発者の承認をお待ちください。", "register_user_success": "ユーザー登録が完了しました。管理者の承認をお待ちください。" },
                "errors": { "invalid_email_password": "メールアドレスまたはパスワードが正しくありません。", "email_already_in_use": "このメールアドレスは既に使用されています。", "weak_password": "パスワードは6文字以上である必要があります。", "account_inactive": "このアカウントは無効です。", "invalid_email": "無効なメールアドレス形式です。", "passwords_not_match": "パスワードが一致しません。" }
            },
            en: { /* English translations */ },
            vi: { /* Vietnamese translations */ }
        };

        // --- I18n Service ---
        class I18n {
            constructor() { this.lang = "ja"; this.translations = {}; this.supportedLanguages = ["ja", "en", "vi"]; }
            async init() { await this.setLanguage(localStorage.getItem("lang") || this.lang); }
            async setLanguage(lang) { this.lang = this.supportedLanguages.includes(lang) ? lang : "ja"; localStorage.setItem("lang", this.lang); this.loadTranslations(this.lang); this.updateUI(); }
            loadTranslations(lang) { this.translations = translationsData[lang] || translationsData.ja; }
            t(key, params = {}) { let translation = key.split('.').reduce((obj, k) => obj && obj[k], this.translations); if (translation) { for (const param in params) { translation = translation.replace(new RegExp(`{{${param}}}`, 'g'), params[param]); } } return translation || key; }
            updateUI(element = document) { element.querySelectorAll("[data-i18n]").forEach(el => { const key = el.getAttribute("data-i18n"); const params = JSON.parse(el.getAttribute("data-i18n-params") || "{}"); el.textContent = this.t(key, params); }); element.querySelectorAll("[data-i18n-placeholder]").forEach(el => { const key = el.getAttribute("data-i18n-placeholder"); el.placeholder = this.t(key); }); }
        }

        // --- Auth Service ---
        class Auth {
            constructor(app) { this.app = app; this.auth = window.firebase.auth; this.db = window.firebase.db; }
            init() { return new Promise((resolve) => { onAuthStateChanged(this.auth, async (user) => { if (user) { try { const userProfile = await this.getUserProfile(user.uid); this.app.currentUser = userProfile ? { uid: user.uid, ...userProfile } : user; } catch (error) { console.error("Error fetching user profile:", error); this.app.currentUser = null; await this.logout(); } } else { this.app.currentUser = null; } resolve(); }); }); }
            async getUserProfile(uid) { const userDocRef = doc(this.db, "users", uid); const userDocSnap = await getDoc(userDocRef); return userDocSnap.exists() ? userDocSnap.data() : null; }
            async login(email, password) { await signInWithEmailAndPassword(this.auth, email, password); }
            async logout() { await firebaseSignOut(this.auth); }
            async registerWithEmail(email, password) { return await createUserWithEmailAndPassword(this.auth, email, password); }
            getFirebaseAuthErrorMessage(error) {
                switch (error.code) {
                    case 'auth/invalid-email': return this.app.i18n.t('errors.invalid_email');
                    case 'auth/user-disabled': return this.app.i18n.t('errors.account_inactive');
                    case 'auth/user-not-found': case 'auth/wrong-password': return this.app.i18n.t('errors.invalid_email_password');
                    case 'auth/email-already-in-use': return this.app.i18n.t('errors.email_already_in_use');
                    case 'auth/weak-password': return this.app.i18n.t('errors.weak_password');
                    default: return error.message;
                }
            }
        }

        // --- API Service ---
        class API {
            constructor(app) { this.app = app; this.db = window.firebase.db; this.functions = window.firebase.functions; }
            async getDashboardStats() { if (!this.app.currentUser?.tenantId) return { totalUsers: 0, completedEvaluations: 0, pendingEvaluations: 0 }; const tenantId = this.app.currentUser.tenantId; const usersQuery = query(collection(this.db, "users"), where("tenantId", "==", tenantId)); const completedEvalsQuery = query(collection(this.db, "evaluations"), where("tenantId", "==", tenantId), where("status", "==", "completed")); const pendingEvalsQuery = query(collection(this.db, "evaluations"), where("tenantId", "==", tenantId), where("status", "!=", "completed")); const [usersSnapshot, completedEvalsSnapshot, pendingEvalsSnapshot] = await Promise.all([ getCountFromServer(usersQuery), getCountFromServer(completedEvalsQuery), getCountFromServer(pendingEvalsQuery) ]); return { totalUsers: usersSnapshot.data().count, completedEvaluations: completedEvalsSnapshot.data().count, pendingEvaluations: pendingEvalsSnapshot.data().count }; }
            async getUsers(status) { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "users"), where("tenantId", "==", this.app.currentUser.tenantId), where("status", "==", status)); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })); }
            async getSubordinates() { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "users"), where("tenantId", "==", this.app.currentUser.tenantId), where("evaluatorId", "==", this.app.currentUser.uid)); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })); }
            async updateUserStatus(userId, status) { const userDocRef = doc(this.db, "users", userId); await updateDoc(userDocRef, { status: status }); }
            async deleteUser(userId) { const userDocRef = doc(this.db, "users", userId); await deleteDoc(userDocRef); }
            async getEvaluations() { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "evaluations"), where("tenantId", "==", this.app.currentUser.tenantId)); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })); }
            async getEvaluationById(id) { const docRef = doc(this.db, "evaluations", id); const docSnap = await getDoc(docRef); if (docSnap.exists() && docSnap.data().tenantId === this.app.currentUser.tenantId) { return { id: docSnap.id, ...docSnap.data() }; } return null; }
            async getPastEvaluationsForUser(userId, currentEvalId) { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "evaluations"), where("tenantId", "==", this.app.currentUser.tenantId), where("targetUserId", "==", userId), where("status", "==", "completed")); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(e => e.id !== currentEvalId); }
            async getSettings() { if (!this.app.currentUser?.tenantId) return { jobTypes: [], periods: [], structures: {} }; const tenantId = this.app.currentUser.tenantId; const jobTypesQuery = query(collection(this.db, "targetJobTypes"), where("tenantId", "==", tenantId)); const periodsQuery = query(collection(this.db, "evaluationPeriods"), where("tenantId", "==", tenantId)); const structuresQuery = query(collection(this.db, "evaluationStructures"), where("tenantId", "==", tenantId)); const [jobTypesSnap, periodsSnap, structuresSnap] = await Promise.all([getDocs(jobTypesQuery), getDocs(periodsQuery), getDocs(structuresSnap)]); const structures = {}; structuresSnap.forEach(doc => { structures[doc.id] = doc.data(); }); return { jobTypes: jobTypesSnap.docs.map(d => ({ id: d.id, ...d.data() })), periods: periodsSnap.docs.map(d => ({ id: d.id, ...d.data() })), structures }; }
            async saveSettings(settings) { const batch = writeBatch(this.db); const tenantId = this.app.currentUser.tenantId; settings.jobTypes.forEach(jt => batch.set(doc(this.db, "targetJobTypes", jt.id), { ...jt, tenantId })); settings.periods.forEach(p => batch.set(doc(this.db, "evaluationPeriods", p.id), { ...p, tenantId })); Object.values(settings.structures).forEach(s => batch.set(doc(this.db, "evaluationStructures", s.id), { ...s, tenantId })); await batch.commit(); }
            async saveEvaluation(data) { if (data.id) { const docRef = doc(this.db, "evaluations", data.id); await updateDoc(docRef, data); } else { await addDoc(collection(this.db, "evaluations"), data); } }
            async getGoals(userId, periodId) { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "qualitativeGoals"), where("tenantId", "==", this.app.currentUser.tenantId), where("userId", "==", userId), where("periodId", "==", periodId)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) return null; const doc = querySnapshot.docs[0]; return { id: doc.id, ...doc.data() }; }
            async getPendingGoals() { if (!this.app.currentUser?.tenantId) return []; const q = query(collection(this.db, "qualitativeGoals"), where("tenantId", "==", this.app.currentUser.tenantId), where("status", "==", "pending_approval")); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })); }
            async saveGoals(goalData) { if (goalData.id) { const docRef = doc(this.db, "qualitativeGoals", goalData.id); await updateDoc(docRef, goalData); } else { await addDoc(collection(this.db, "qualitativeGoals"), goalData); } }
            async updateGoalStatus(goalId, status) { const docRef = doc(this.db, "qualitativeGoals", goalId); await updateDoc(docRef, { status }); }
            async getPendingAdmins() { return (await getDocs(query(collection(this.db, "users"), where("status", "==", "developer_approval_pending")))).docs.map(d => ({ id: d.id, ...d.data() })); }
            async approveAdmin(userId) { const approveAdminFunction = httpsCallable(this.functions, 'approveAdmin'); await approveAdminFunction({ userId }); }
            async getInvitation(token) { const q = query(collection(this.db, "invitations"), where("token", "==", token)); const snapshot = await getDocs(q); if (snapshot.empty) return null; const doc = snapshot.docs[0]; return { id: doc.id, ...doc.data() }; }
            async createUserProfile(uid, data) { await setDoc(doc(this.db, "users", uid), data); }
        }

        // --- Component Classes ---
        class HeaderComponent {
            constructor(app) { this.app = app; }
            update() {
                const container = document.getElementById('header-container');
                if (!this.app.isAuthenticated()) { container.innerHTML = ''; return; }
                container.innerHTML = `<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <div class="container-fluid">
                        <button class="navbar-toggler d-lg-none" type="button" onclick="window.app.sidebar.toggle()"><span class="navbar-toggler-icon"></span></button>
                        <a class="navbar-brand" href="#/dashboard">評価システム</a>
                        <div class="collapse navbar-collapse">
                            <ul class="navbar-nav ms-auto">
                                <li class="nav-item"><a class="nav-link" href="#" onclick="event.preventDefault(); window.app.logout();">${this.app.i18n.t('nav.logout')}</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>`;
                this.app.i18n.updateUI(container);
            }
        }
        class SidebarComponent {
            constructor(app) { this.app = app; }
            update() {
                const container = document.getElementById('sidebar-container');
                if (!this.app.isAuthenticated()) { container.innerHTML = ''; return; }
                const role = this.app.currentUser.role;
                const activePath = window.location.hash;

                const menuItems = [
                    { path: '#/dashboard', icon: 'fa-tachometer-alt', labelKey: 'nav.dashboard', roles: ['admin', 'evaluator', 'worker', 'developer'] },
                    { path: '#/evaluations', icon: 'fa-clipboard-list', labelKey: 'nav.evaluations', roles: ['admin', 'evaluator', 'worker'] },
                    { path: '#/evaluation-form', icon: 'fa-edit', labelKey: 'nav.evaluation', roles: ['admin', 'evaluator', 'worker'] },
                    { path: '#/goal-setting', icon: 'fa-bullseye', labelKey: 'nav.goals', roles: ['evaluator', 'worker'] },
                    { path: '#/goal-approvals', icon: 'fa-check-circle', labelKey: 'nav.goal_approvals', roles: ['admin'] },
                    { path: '#/users', icon: 'fa-users', labelKey: 'nav.users', roles: ['admin'] },
                    { path: '#/settings', icon: 'fa-cog', labelKey: 'nav.settings', roles: ['admin'] },
                    { path: '#/developer', icon: 'fa-code', labelKey: 'nav.developer', roles: ['developer'] },
                ];
                
                container.innerHTML = `<div class="sidebar bg-dark text-white p-3 d-flex flex-column">
                    <nav class="nav flex-column">
                        ${menuItems.filter(item => item.roles.includes(role)).map(item => `
                            <a class="nav-link text-white ${activePath.startsWith(item.path) ? 'active' : ''}" href="${item.path}">
                                <i class="fas ${item.icon} fa-fw me-2"></i><span data-i18n="${item.labelKey}"></span>
                            </a>
                        `).join('')}
                    </nav>
                </div>`;
                this.app.i18n.updateUI(container);
            }
            toggle() { document.getElementById('sidebar-container').classList.toggle('show'); }
        }

        // --- Page Classes ---
        class LoginPage {
            constructor(app) { this.app = app; }
            async render() {
                return `
                    <div class="d-flex align-items-center justify-content-center vh-100">
                        <div class="card p-4 shadow" style="width: 100%; max-width: 400px;">
                            <h3 class="text-center mb-4" data-i18n="auth.login"></h3>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="email" class="form-label" data-i18n="auth.email"></label>
                                    <input type="email" id="email" class="form-control" required autocomplete="email">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label" data-i18n="auth.password"></label>
                                    <input type="password" id="password" class="form-control" required autocomplete="current-password">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span data-i18n="auth.login"></span>
                                </button>
                            </form>
                            <div class="text-center mt-3">
                                <a href="#/register-admin" data-i18n="auth.register_admin"></a>
                            </div>
                        </div>
                    </div>`;
            }
            async init() {
                this.app.i18n.updateUI();
                const form = document.getElementById('loginForm');
                const submitButton = form.querySelector('button[type="submit"]');
                const spinner = submitButton.querySelector('.spinner-border');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    spinner.classList.remove('d-none');
                    submitButton.disabled = true;

                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    try {
                        await this.app.login(email, password);
                    } catch (err) {
                        alert(this.app.auth.getFirebaseAuthErrorMessage(err));
                        spinner.classList.add('d-none');
                        submitButton.disabled = false;
                    }
                });
            }
        }
        class DashboardPage {
            constructor(app) { this.app = app; this.stats = {}; this.chart = null; }
            async render() {
                const userName = this.app.currentUser.name || this.app.currentUser.email;
                return `
                    <h1 data-i18n="nav.dashboard"></h1>
                    <p class="lead">${this.app.i18n.t('dashboard.welcome', {userName: userName})}</p>
                    
                    <div class="row">
                        <div class="col-md-4 mb-4"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-users fa-3x text-primary mb-3"></i><h5 class="card-title" data-i18n="dashboard.total_users"></h5><p class="display-4" id="total-users-stat">...</p></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-check-circle fa-3x text-success mb-3"></i><h5 class="card-title" data-i18n="dashboard.completed_evaluations"></h5><p class="display-4" id="completed-evals-stat">...</p></div></div></div>
                        <div class="col-md-4 mb-4"><div class="card h-100"><div class="card-body text-center"><i class="fas fa-hourglass-half fa-3x text-warning mb-3"></i><h5 class="card-title" data-i18n="dashboard.pending_evaluations"></h5><p class="display-4" id="pending-evals-stat">...</p></div></div></div>
                    </div>
                    <div class="card"><div class="card-header"><h5 class="card-title mb-0" data-i18n="dashboard.evaluation_overview"></h5></div><div class="card-body"><canvas id="overviewChart"></canvas></div></div>`;
            }
            async init() {
                this.app.i18n.updateUI();
                try {
                    this.stats = await this.app.api.getDashboardStats();
                    this.updateStatsUI(); this.renderChart();
                } catch (error) { console.error("Failed to load dashboard stats:", error); this.app.showError("ダッシュボードデータの読み込みに失敗しました。"); }
            }
            updateStatsUI() { document.getElementById('total-users-stat').textContent = this.stats.totalUsers; document.getElementById('completed-evals-stat').textContent = this.stats.completedEvaluations; document.getElementById('pending-evals-stat').textContent = this.stats.pendingEvaluations; }
            renderChart() { const ctx = document.getElementById('overviewChart').getContext('2d'); if (this.chart) { this.chart.destroy(); } this.chart = new Chart(ctx, { type: 'bar', data: { labels: [this.app.i18n.t('dashboard.completed_evaluations'), this.app.i18n.t('dashboard.pending_evaluations')], datasets: [{ label: this.app.i18n.t('dashboard.evaluation_overview'), data: [this.stats.completedEvaluations, this.stats.pendingEvaluations], backgroundColor: [ 'rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)' ], borderColor: [ 'rgba(40, 167, 69, 1)', 'rgba(255, 193, 7, 1)' ], borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false } }); }
        }
        class UserManagementPage {
            constructor(app) { this.app = app; this.activeUsers = []; this.pendingUsers = []; this.selectedTab = 'active'; }
            async render() {
                return `
                    <h1 data-i18n="users.title"></h1>
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><button class="nav-link active" id="active-tab-btn" data-i18n="users.active_users"></button></li>
                        <li class="nav-item"><button class="nav-link" id="pending-tab-btn"><span data-i18n="users.pending_approvals"></span> <span class="badge bg-warning text-dark" id="pending-count">0</span></button></li>
                    </ul>
                    <div id="active-users-view"></div>
                    <div id="pending-users-view" class="d-none"></div>`;
            }
            async init() {
                if (!this.app.currentUser || this.app.currentUser.role !== 'admin') { window.location.hash = '/dashboard'; return; }
                document.getElementById('active-tab-btn').addEventListener('click', () => this.switchTab('active'));
                document.getElementById('pending-tab-btn').addEventListener('click', () => this.switchTab('pending'));
                await this.loadData();
            }
            async loadData() {
                try {
                    [this.activeUsers, this.pendingUsers] = await Promise.all([
                        this.app.api.getUsers('active'),
                        this.app.api.getUsers('pending_approval')
                    ]);
                    document.getElementById('pending-count').textContent = this.pendingUsers.length;
                    this.renderTables();
                    this.app.i18n.updateUI();
                } catch (error) { console.error("Failed to load users:", error); this.app.showError("ユーザーデータの読み込みに失敗しました。"); }
            }
            renderTables() {
                document.getElementById('active-users-view').innerHTML = this.createTable(this.activeUsers, false);
                document.getElementById('pending-users-view').innerHTML = this.createTable(this.pendingUsers, true);
            }
            createTable(users, isPending) {
                if (users.length === 0) return `<div class="card card-body text-center" data-i18n="common.no_data"></div>`;
                return `<div class="card"><div class="table-responsive"><table class="table table-hover mb-0">
                    <thead><tr><th data-i18n="auth.name"></th><th data-i18n="auth.email"></th><th data-i18n="users.role"></th><th data-i18n="users.actions"></th></tr></thead>
                    <tbody>${users.map(user => `
                        <tr>
                            <td>${user.name || ''}</td>
                            <td>${user.email}</td>
                            <td><span class="badge ${this.app.getRoleBadgeClass(user.role)}" data-i18n="roles.${user.role}"></span></td>
                            <td>
                                ${isPending ? `
                                    <button class="btn btn-sm btn-success" onclick="window.app.currentPage.approveUser('${user.id}')"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="window.app.currentPage.rejectUser('${user.id}')"><i class="fas fa-times"></i></button>
                                ` : `
                                    <button class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></button>
                                `}
                            </td>
                        </tr>`).join('')}
                    </tbody></table></div></div>`;
            }
            switchTab(tab) {
                this.selectedTab = tab;
                document.getElementById('active-users-view').classList.toggle('d-none', tab !== 'active');
                document.getElementById('pending-users-view').classList.toggle('d-none', tab !== 'pending');
                document.getElementById('active-tab-btn').classList.toggle('active', tab === 'active');
                document.getElementById('pending-tab-btn').classList.toggle('active', tab === 'pending');
            }
            async approveUser(userId) {
                if (confirm(this.app.i18n.t('users.confirm_approve'))) {
                    try { await this.app.api.updateUserStatus(userId, 'active'); this.app.showSuccess(this.app.i18n.t('users.approve_success')); await this.loadData(); } catch (e) { this.app.showError(e.message); }
                }
            }
            async rejectUser(userId) {
                if (confirm(this.app.i18n.t('users.confirm_reject'))) {
                    try { await this.app.api.deleteUser(userId); this.app.showSuccess(this.app.i18n.t('users.reject_success')); await this.loadData(); } catch (e) { this.app.showError(e.message); }
                }
            }
        }
        class EvaluationsPage {
            constructor(app) { this.app = app; this.evaluations = []; }
            async render() {
                return `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 data-i18n="evaluations.title"></h1>
                        <a href="#/evaluation-form" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i><span data-i18n="evaluations.new_evaluation"></span>
                        </a>
                    </div>
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th data-i18n="evaluations.period"></th>
                                        <th data-i18n="evaluations.target_user"></th>
                                        <th data-i18n="evaluations.evaluator"></th>
                                        <th data-i18n="users.status"></th>
                                        <th data-i18n="evaluations.total_score"></th>
                                        <th data-i18n="users.actions"></th>
                                    </tr>
                                </thead>
                                <tbody id="evaluations-table-body"></tbody>
                            </table>
                        </div>
                    </div>`;
            }
            async init() {
                await this.loadData();
                this.app.i18n.updateUI();
            }
            async loadData() {
                const tbody = document.getElementById('evaluations-table-body');
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">${this.app.i18n.t('common.loading')}</td></tr>`;
                try {
                    this.evaluations = await this.app.api.getEvaluations();
                    this.renderTable();
                } catch (error) {
                    console.error("Failed to load evaluations:", error);
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${this.app.i18n.t('common.error')}</td></tr>`;
                }
            }
            renderTable() {
                const tbody = document.getElementById('evaluations-table-body');
                if (this.evaluations.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center" data-i18n="common.no_data"></td></tr>`;
                    this.app.i18n.updateUI(tbody);
                    return;
                }
                tbody.innerHTML = this.evaluations.map(e => `
                    <tr>
                        <td>${e.periodName || ''}</td>
                        <td>${e.targetUserName || ''}</td>
                        <td>${e.evaluatorName || ''}</td>
                        <td><span class="badge ${this.app.getStatusBadgeClass(e.status)}" data-i18n="status.${e.status}"></span></td>
                        <td>${e.totalScore || '-'}</td>
                        <td>
                            <a href="#/report?id=${e.id}" class="btn btn-sm btn-outline-secondary" data-i18n="common.details"></a>
                        </td>
                    </tr>
                `).join('');
                this.app.i18n.updateUI(tbody);
            }
        }
        class EvaluationReportPage {
            constructor(app) { this.app = app; this.currentEvaluation = null; this.pastEvaluations = []; this.comparisonChart = null; }
            async render() {
                if (!this.currentEvaluation) return `<div class="text-center p-5">${this.app.i18n.t('common.loading')}</div>`;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 data-i18n="reports.title"></h1>
                        <a href="#/evaluations" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back"></span></a>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" data-i18n="reports.comparison"></h5>
                            <select id="past-eval-select" class="form-select form-select-sm w-auto">
                                <option value="" data-i18n="reports.select_comparison"></option>
                            </select>
                        </div>
                        <div class="card-body">
                            <canvas id="comparison-chart" style="max-height: 400px;"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0" data-i18n="common.details"></h5></div>
                        <div class="card-body" id="report-details"></div>
                    </div>
                `;
            }
            async init() {
                const params = new URLSearchParams(window.location.hash.split('?')[1] || '');
                const evalId = params.get('id');
                if (!evalId) { window.location.hash = '/evaluations'; return; }

                try {
                    this.currentEvaluation = await this.app.api.getEvaluationById(evalId);
                    if (!this.currentEvaluation) throw new Error("Evaluation not found.");
                    
                    this.pastEvaluations = await this.app.api.getPastEvaluationsForUser(this.currentEvaluation.targetUserId, evalId);
                    
                    const content = document.getElementById('content');
                    content.innerHTML = await this.render();
                    
                    this.populatePastEvalsDropdown();
                    this.renderDetails();
                    this.renderChart();
                    
                    document.getElementById('past-eval-select').addEventListener('change', (e) => this.updateChart(e.target.value));
                    this.app.i18n.updateUI();
                } catch (error) {
                    console.error("Failed to load report:", error);
                    this.app.showError("レポートの読み込みに失敗しました。");
                }
            }
            populatePastEvalsDropdown() {
                const select = document.getElementById('past-eval-select');
                if (this.pastEvaluations.length === 0) {
                    select.disabled = true;
                    select.innerHTML = `<option>${this.app.i18n.t('reports.no_past_evaluations')}</option>`;
                    return;
                }
                this.pastEvaluations.forEach(ev => {
                    const option = document.createElement('option');
                    option.value = ev.id;
                    option.textContent = ev.periodName;
                    select.appendChild(option);
                });
            }
            renderDetails() { /* Logic to display detailed scores and comments */ }
            renderChart(comparisonId = null) {
                const ctx = document.getElementById('comparison-chart').getContext('2d');
                const currentData = this.getChartData(this.currentEvaluation);
                const datasets = [{
                    label: this.currentEvaluation.periodName,
                    data: currentData.data,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                }];

                if (comparisonId) {
                    const pastEval = this.pastEvaluations.find(e => e.id === comparisonId);
                    if (pastEval) {
                        const pastData = this.getChartData(pastEval);
                        datasets.push({
                            label: pastEval.periodName,
                            data: pastData.data,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        });
                    }
                }

                if (this.comparisonChart) this.comparisonChart.destroy();
                this.comparisonChart = new Chart(ctx, {
                    type: 'radar',
                    data: { labels: currentData.labels, datasets: datasets },
                    options: { scales: { r: { beginAtZero: true, max: 5 } }, responsive: true, maintainAspectRatio: false }
                });
            }
            updateChart(comparisonId) { this.renderChart(comparisonId); }
            getChartData(evaluation) {
                // Dummy data for now. Real implementation would parse evaluation.ratings
                const labels = ['技術力', 'コミュニケーション', 'チームワーク', '問題解決', '安全意識'];
                const data = labels.map(() => (Math.random() * 4 + 1).toFixed(1));
                return { labels, data };
            }
        }
        class SettingsPage {
            constructor(app) { this.app = app; this.settings = { jobTypes: [], periods: [], structures: {} }; this.selectedJobType = null; this.hasUnsavedChanges = false; }
            async render() {
                return `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 data-i18n="settings.title"></h1>
                        <button id="save-settings-btn" class="btn btn-success" disabled><i class="fas fa-save me-2"></i><span data-i18n="settings.save_changes"></span></button>
                    </div>
                    <div class="settings-layout">
                        <div class="settings-sidebar">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0" data-i18n="settings.job_types"></h5><button class="btn btn-sm btn-primary" id="add-job-type-btn"><i class="fas fa-plus"></i></button></div>
                                <div class="list-group list-group-flush" id="job-types-list"></div>
                            </div>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0" data-i18n="settings.evaluation_periods"></h5><button class="btn btn-sm btn-primary" id="add-period-btn"><i class="fas fa-plus"></i></button></div>
                                <div class="list-group list-group-flush" id="periods-list"></div>
                            </div>
                        </div>
                        <div class="settings-main card">
                            <div class="card-body" id="structure-editor">
                                <div class="text-center p-5 text-muted" data-i18n="common.select">職種を選択してください</div>
                            </div>
                        </div>
                    </div>`;
            }
            async init() {
                if (this.app.currentUser.role !== 'admin') { window.location.hash = '/dashboard'; return; }
                await this.loadData();
                document.getElementById('save-settings-btn').addEventListener('click', () => this.saveSettings());
                document.getElementById('add-job-type-btn').addEventListener('click', () => this.addJobType());
                document.getElementById('add-period-btn').addEventListener('click', () => this.addPeriod());
                this.app.i18n.updateUI();
            }
            async loadData() {
                this.settings = await this.app.api.getSettings();
                this.renderSidebars();
            }
            renderSidebars() {
                this.renderJobTypesList();
                this.renderPeriodsList();
            }
            renderJobTypesList() {
                const list = document.getElementById('job-types-list');
                list.innerHTML = this.settings.jobTypes.map(jt => `<a href="#" class="list-group-item list-group-item-action ${this.selectedJobType?.id === jt.id ? 'active' : ''}" data-id="${jt.id}">${jt.name}</a>`).join('');
                list.querySelectorAll('a').forEach(a => a.addEventListener('click', (e) => { e.preventDefault(); this.selectJobType(e.target.dataset.id); }));
            }
            renderPeriodsList() { /* ... similar to job types ... */ }
            selectJobType(id) { this.selectedJobType = this.settings.jobTypes.find(jt => jt.id === id); this.renderStructureEditor(); this.renderJobTypesList(); }
            renderStructureEditor() {
                const editor = document.getElementById('structure-editor');
                if (!this.selectedJobType) { editor.innerHTML = `<div class="text-center p-5 text-muted">職種を選択してください</div>`; return; }
                const structure = this.settings.structures[this.selectedJobType.id] || { id: this.selectedJobType.id, categories: [] };
                editor.innerHTML = `<h3>${this.selectedJobType.name} の評価構造</h3> ... エディタのUI ...`;
            }
            addJobType() { const name = prompt('新しい職種名:'); if (name) { this.settings.jobTypes.push({ id: `jt_${Date.now()}`, name }); this.markUnsaved(); this.renderJobTypesList(); } }
            addPeriod() { /* ... */ }
            markUnsaved() { this.hasUnsavedChanges = true; document.getElementById('save-settings-btn').disabled = false; }
            async saveSettings() { try { await this.app.api.saveSettings(this.settings); this.hasUnsavedChanges = false; document.getElementById('save-settings-btn').disabled = true; this.app.showSuccess(this.app.i18n.t('messages.save_success')); } catch (e) { this.app.showError(e.message); } }
        }
        class EvaluationFormPage {
            constructor(app) { this.app = app; this.evaluationData = {}; this.targetUser = null; this.selectedPeriod = null; this.evaluationStructure = null; this.usersForEvaluation = []; this.periods = []; }
            async render() {
                return `
                    <h1 data-i18n="evaluations.form_title"></h1>
                    <div class="card mb-4">
                        <div class="card-header"><h5 class="mb-0" data-i18n="evaluations.target_info"></h5></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="targetUserSelect" class="form-label" data-i18n="evaluations.select_target_user"></label>
                                    <select id="targetUserSelect" class="form-select"></select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="periodSelect" class="form-label" data-i18n="evaluations.select_period"></label>
                                    <select id="periodSelect" class="form-select"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="form-columns" class="row"></div>
                    <div class="text-end mt-4">
                        <button id="submit-eval-btn" class="btn btn-primary btn-lg" data-i18n="common.submit" disabled></button>
                    </div>
                `;
            }
            async init() {
                await this.loadInitialData();
                document.getElementById('targetUserSelect').addEventListener('change', () => this.onSelectionChange());
                document.getElementById('periodSelect').addEventListener('change', () => this.onSelectionChange());
                document.getElementById('submit-eval-btn').addEventListener('click', () => this.submitEvaluation());
                this.app.i18n.updateUI();
            }
            async loadInitialData() {
                const settings = await this.app.api.getSettings();
                this.periods = settings.periods;
                
                const userSelect = document.getElementById('targetUserSelect');
                if (this.app.currentUser.role === 'worker') {
                    this.usersForEvaluation = [this.app.currentUser];
                    userSelect.innerHTML = `<option value="${this.app.currentUser.uid}">${this.app.currentUser.name}</option>`;
                    userSelect.disabled = true;
                } else {
                    this.usersForEvaluation = await this.app.api.getSubordinates();
                    userSelect.innerHTML = `<option value="">${this.app.i18n.t('common.select')}</option>` + this.usersForEvaluation.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                }
                
                const periodSelect = document.getElementById('periodSelect');
                periodSelect.innerHTML = `<option value="">${this.app.i18n.t('common.select')}</option>` + this.periods.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
            async onSelectionChange() {
                const userId = document.getElementById('targetUserSelect').value;
                const periodId = document.getElementById('periodSelect').value;
                if (!userId || !periodId) {
                    document.getElementById('form-columns').innerHTML = '';
                    document.getElementById('submit-eval-btn').disabled = true;
                    return;
                }
                this.targetUser = this.usersForEvaluation.find(u => u.id === userId);
                this.selectedPeriod = this.periods.find(p => p.id === periodId);
                
                // Fetch evaluation structure and existing data
                // For simplicity, using dummy structure for now.
                this.evaluationStructure = { categories: [{ id: 'cat1', name: '技術スキル', items: [{id: 'item1', name: '専門知識', type: 'quantitative'}] }] };
                this.renderForm();
                document.getElementById('submit-eval-btn').disabled = false;
            }
            renderForm() {
                const container = document.getElementById('form-columns');
                const canEditSelf = this.app.currentUser.uid === this.targetUser.id;
                const canEditEval = this.app.currentUser.role !== 'worker' && this.app.currentUser.uid !== this.targetUser.id;

                container.innerHTML = `
                    <div class="col-lg-6">
                        <div class="card"><div class="card-header"><h5 data-i18n="reports.self_assessment"></h5></div>
                        <div class="card-body">${this.renderItems('self', canEditSelf)}</div></div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card"><div class="card-header"><h5 data-i18n="reports.evaluator_assessment"></h5></div>
                        <div class="card-body">${this.renderItems('eval', canEditEval)}</div></div>
                    </div>`;
                this.app.i18n.updateUI(container);
            }
            renderItems(type, canEdit) {
                if (!this.evaluationStructure) return '';
                return this.evaluationStructure.categories.map(cat => 
                    cat.items.map(item => `
                        <div class="mb-3">
                            <label class="form-label fw-bold">${item.name}</label>
                            <input type="number" class="form-control mb-1" placeholder="${this.app.i18n.t('reports.score')}" min="1" max="5" ${canEdit ? '' : 'readonly'} oninput="window.app.currentPage.updateData('${item.id}', '${type}Score', this.value)">
                            <textarea class="form-control" rows="2" placeholder="${this.app.i18n.t('reports.comment')}" ${canEdit ? '' : 'readonly'} oninput="window.app.currentPage.updateData('${item.id}', '${type}Comment', this.value)"></textarea>
                        </div>
                    `).join('')
                ).join('');
            }
            updateData(itemId, field, value) {
                if (!this.evaluationData[itemId]) this.evaluationData[itemId] = {};
                this.evaluationData[itemId][field] = value;
            }
            async submitEvaluation() {
                if (!confirm(this.app.i18n.t('evaluations.confirm_submit'))) return;
                const data = {
                    tenantId: this.app.currentUser.tenantId,
                    targetUserId: this.targetUser.id,
                    targetUserName: this.targetUser.name,
                    periodId: this.selectedPeriod.id,
                    periodName: this.selectedPeriod.name,
                    evaluatorId: this.app.currentUser.uid,
                    evaluatorName: this.app.currentUser.name,
                    ratings: this.evaluationData,
                    status: this.app.currentUser.uid === this.targetUser.id ? 'self_assessed' : 'approved_by_evaluator',
                    submittedAt: serverTimestamp()
                };
                try {
                    await this.app.api.saveEvaluation(data);
                    this.app.showSuccess(this.app.i18n.t('messages.save_success'));
                    window.location.hash = '/evaluations';
                } catch (e) { this.app.showError(e.message); }
            }
        }
        class GoalSettingPage {
            constructor(app) { this.app = app; this.goals = []; this.periods = []; this.existingGoalDoc = null; }
            async render() {
                return `
                    <h1 data-i18n="nav.goals"></h1>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" data-i18n="evaluations.select_period"></h5>
                            <div class="d-flex align-items-center">
                                <span class="me-2" data-i18n="goals.total_weight"></span>: <b id="total-weight">0%</b>
                            </div>
                        </div>
                        <div class="card-body">
                            <select id="period-select" class="form-select mb-3"></select>
                            <div id="goals-container"></div>
                            <button id="add-goal-btn" class="btn btn-secondary mt-2" data-i18n="goals.add_goal" disabled></button>
                        </div>
                        <div class="card-footer text-end">
                            <button id="submit-goals-btn" class="btn btn-primary" data-i18n="common.submit" disabled></button>
                        </div>
                    </div>
                `;
            }
            async init() {
                const settings = await this.app.api.getSettings();
                this.periods = settings.periods;
                this.renderPeriodSelector();
                document.getElementById('period-select').addEventListener('change', (e) => this.loadGoalsForPeriod(e.target.value));
                document.getElementById('add-goal-btn').addEventListener('click', () => this.addGoal());
                document.getElementById('submit-goals-btn').addEventListener('click', () => this.submitGoals());
                this.app.i18n.updateUI();
            }
            renderPeriodSelector() {
                const select = document.getElementById('period-select');
                select.innerHTML = `<option value="">${this.app.i18n.t('common.select')}</option>` + this.periods.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
            async loadGoalsForPeriod(periodId) {
                if (!periodId) { document.getElementById('goals-container').innerHTML = ''; return; }
                this.existingGoalDoc = await this.app.api.getGoals(this.app.currentUser.uid, periodId);
                this.goals = this.existingGoalDoc ? this.existingGoalDoc.goals : [{ text: '', weight: 0 }];
                document.getElementById('add-goal-btn').disabled = false;
                this.renderGoals();
            }
            renderGoals() {
                const container = document.getElementById('goals-container');
                container.innerHTML = this.goals.map((goal, index) => `
                    <div class="row g-2 mb-2 align-items-center">
                        <div class="col"><textarea class="form-control" rows="2" placeholder="目標内容" oninput="window.app.currentPage.updateGoal(${index}, 'text', this.value)">${goal.text}</textarea></div>
                        <div class="col-auto"><input type="number" class="form-control" placeholder="ウェイト(%)" style="width: 120px;" oninput="window.app.currentPage.updateGoal(${index}, 'weight', this.value)" value="${goal.weight}"></div>
                    </div>
                `).join('');
                this.updateTotalWeight();
            }
            updateGoal(index, key, value) {
                this.goals[index][key] = (key === 'weight') ? Number(value) : value;
                this.updateTotalWeight();
            }
            addGoal() { if (this.goals.length < 5) { this.goals.push({ text: '', weight: 0 }); this.renderGoals(); } }
            updateTotalWeight() {
                const total = this.goals.reduce((sum, goal) => sum + (goal.weight || 0), 0);
                document.getElementById('total-weight').textContent = `${total}%`;
                document.getElementById('submit-goals-btn').disabled = total !== 100;
            }
            async submitGoals() {
                const periodId = document.getElementById('period-select').value;
                const data = {
                    id: this.existingGoalDoc?.id,
                    userId: this.app.currentUser.uid,
                    userName: this.app.currentUser.name,
                    periodId: periodId,
                    periodName: this.periods.find(p => p.id === periodId).name,
                    goals: this.goals,
                    status: 'pending_approval',
                    tenantId: this.app.currentUser.tenantId,
                    submittedAt: serverTimestamp()
                };
                try {
                    await this.app.api.saveGoals(data);
                    this.app.showSuccess(this.app.i18n.t('messages.save_success'));
                    window.location.hash = '/dashboard';
                } catch (e) { this.app.showError(e.message); }
            }
        }
        class GoalApprovalsPage {
            constructor(app) { this.app = app; this.pendingGoals = []; }
            async render() {
                return `
                    <h1 data-i18n="goals.approvals_title"></h1>
                    <div id="approvals-list"></div>
                `;
            }
            async init() {
                if (this.app.currentUser.role !== 'admin') { window.location.hash = '/dashboard'; return; }
                await this.loadData();
                this.renderList();
                this.app.i18n.updateUI();
            }
            async loadData() { this.pendingGoals = await this.app.api.getPendingGoals(); }
            renderList() {
                const container = document.getElementById('approvals-list');
                if (this.pendingGoals.length === 0) { container.innerHTML = `<div class="card card-body text-center" data-i18n="common.no_data"></div>`; return; }
                container.innerHTML = this.pendingGoals.map(goalDoc => `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div><strong>${goalDoc.userName}</strong> - ${goalDoc.periodName}</div>
                            <div>
                                <button class="btn btn-sm btn-success" onclick="window.app.currentPage.updateStatus('${goalDoc.id}', 'approved')"><i class="fas fa-check"></i> <span data-i18n="goals.approve"></span></button>
                                <button class="btn btn-sm btn-danger ms-2" onclick="window.app.currentPage.updateStatus('${goalDoc.id}', 'rejected')"><i class="fas fa-times"></i> <span data-i18n="goals.reject"></span></button>
                            </div>
                        </div>
                        <ul class="list-group list-group-flush">
                            ${goalDoc.goals.map(g => `<li class="list-group-item"><b>${g.weight}%:</b> ${g.text}</li>`).join('')}
                        </ul>
                    </div>
                `).join('');
            }
            async updateStatus(id, status) {
                const confirmKey = status === 'approved' ? 'goals.confirm_approve' : 'goals.confirm_reject';
                if (confirm(this.app.i18n.t(confirmKey))) {
                    try {
                        await this.app.api.updateGoalStatus(id, status);
                        this.app.showSuccess(this.app.i18n.t(status === 'approved' ? 'goals.approve_success' : 'goals.reject_success'));
                        await this.loadData();
                        this.renderList();
                    } catch (e) { this.app.showError(e.message); }
                }
            }
        }
        class DeveloperPage {
            constructor(app) { this.app = app; this.pendingAdmins = []; }
            async render() {
                return `
                    <h1 data-i18n="nav.developer"></h1>
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0" data-i18n="developer.admin_approvals"></h5></div>
                        <div id="pending-admins-list"></div>
                    </div>
                `;
            }
            async init() {
                if (this.app.currentUser.role !== 'developer') { window.location.hash = '/dashboard'; return; }
                await this.loadData();
                this.renderList();
                this.app.i18n.updateUI();
            }
            async loadData() { this.pendingAdmins = await this.app.api.getPendingAdmins(); }
            renderList() {
                const container = document.getElementById('pending-admins-list');
                if (this.pendingAdmins.length === 0) { container.innerHTML = `<div class="card-body text-center" data-i18n="common.no_data"></div>`; return; }
                container.innerHTML = `<div class="table-responsive"><table class="table mb-0">
                    <thead><tr><th>氏名</th><th>Email</th><th>企業名</th><th>操作</th></tr></thead>
                    <tbody>${this.pendingAdmins.map(admin => `
                        <tr>
                            <td>${admin.name}</td>
                            <td>${admin.email}</td>
                            <td>${admin.companyName}</td>
                            <td><button class="btn btn-sm btn-success" onclick="window.app.currentPage.approve('${admin.id}')" data-i18n="developer.approve"></button></td>
                        </tr>
                    `).join('')}</tbody>
                </table></div>`;
            }
            async approve(userId) {
                if (confirm(this.app.i18n.t('developer.confirm_approve'))) {
                    try { await this.app.api.approveAdmin(userId); this.app.showSuccess(this.app.i18n.t('developer.approve_success')); await this.loadData(); this.renderList(); } catch (e) { this.app.showError(e.message); }
                }
            }
        }
        class RegisterAdminPage {
            constructor(app) { this.app = app; }
            async render() {
                return `<div class="d-flex align-items-center justify-content-center vh-100">
                    <div class="card p-4 shadow" style="width: 100%; max-width: 500px;">
                        <h3 class="text-center mb-4" data-i18n="auth.register_admin"></h3>
                        <form id="registerAdminForm">
                            <div class="mb-3"><label class="form-label" data-i18n="auth.company"></label><input type="text" id="companyName" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label" data-i18n="auth.name"></label><input type="text" id="name" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label" data-i18n="auth.email"></label><input type="email" id="email" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label" data-i18n="auth.password"></label><input type="password" id="password" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label" data-i18n="auth.confirm_password"></label><input type="password" id="confirmPassword" class="form-control" required></div>
                            <button type="submit" class="btn btn-primary w-100" data-i18n="auth.register_admin"></button>
                        </form>
                    </div>
                </div>`;
            }
            async init() {
                this.app.i18n.updateUI();
                document.getElementById('registerAdminForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const password = document.getElementById('password').value;
                    if (password !== document.getElementById('confirmPassword').value) { alert(this.app.i18n.t('errors.passwords_not_match')); return; }
                    
                    const data = {
                        email: document.getElementById('email').value,
                        password: password,
                        name: document.getElementById('name').value,
                        companyName: document.getElementById('companyName').value,
                    };
                    
                    try {
                        const registerAdmin = httpsCallable(this.app.functions, 'registerAdmin');
                        await registerAdmin(data);
                        alert(this.app.i18n.t('messages.register_admin_success'));
                        window.location.hash = '/login';
                    } catch (err) {
                        alert(this.app.auth.getFirebaseAuthErrorMessage(err));
                    }
                });
            }
        }
        class RegisterPage { constructor(app) {this.app = app;} async render() { return `<h1>ユーザー登録</h1><p>招待トークンが必要です。</p>`; } async init() {} }
        
        // --- Router Service ---
        class Router {
            constructor(app) {
              this.app = app;
              this.routes = { "/": LoginPage, "/login": LoginPage, "/dashboard": DashboardPage, "/users": UserManagementPage, "/evaluations": EvaluationsPage, "/report": EvaluationReportPage, "/settings": SettingsPage, "/evaluation-form": EvaluationFormPage, "/goal-setting": GoalSettingPage, "/goal-approvals": GoalApprovalsPage, "/developer": DeveloperPage, "/register": RegisterPage, "/register-admin": RegisterAdminPage };
            }
            async route() {
                const path = window.location.hash.substring(1).split('?')[0] || "/";
                const PageClass = this.routes[path] || LoginPage;
                const requiresAuth = !["/", "/login", "/register", "/register-admin"].includes(path);

                if (requiresAuth && !this.app.isAuthenticated()) { window.location.hash = "/login"; return; }
                if (!requiresAuth && this.app.isAuthenticated() && (path === '/' || path === '/login')) { window.location.hash = "/dashboard"; return; }
                
                this.app.header.update();
                this.app.sidebar.update();

                const pageInstance = new PageClass(this.app);
                const contentContainer = document.getElementById("content");
                contentContainer.innerHTML = await pageInstance.render();
                if (typeof pageInstance.init === "function") await pageInstance.init();
            }
        }

        // --- Main App Class ---
        class App {
            constructor() {
                this.currentUser = null;
                this.i18n = new I18n();
                this.auth = new Auth(this);
                this.api = new API(this);
                this.header = new HeaderComponent(this);
                this.sidebar = new SidebarComponent(this);
                this.router = new Router(this);
            }
            async init() {
                try {
                    await this.i18n.init();
                    this.auth.init().then(() => {
                        this.setupEventListeners();
                        this.router.route();
                        this.showApp();
                    });
                } catch (error) { console.error("App Init Failed:", error); }
            }
            setupEventListeners() { window.addEventListener("hashchange", () => this.router.route()); }
            showApp() { document.getElementById("loading-screen").style.display = "none"; document.getElementById("app").classList.remove("d-none"); }
            isAuthenticated() { return !!this.currentUser; }
            async login(email, password) { await this.auth.login(email, password); }
            async logout() { await this.auth.logout(); }
            showError(message) { alert(message); }
            showSuccess(message) { console.log(message); }
            getRoleBadgeClass(role) { return { developer: "bg-dark", admin: "bg-danger", evaluator: "bg-info", worker: "bg-secondary" }[role] || "bg-light text-dark"; }
            getStatusBadgeClass(status) { const classes = { active: "bg-success", developer_approval_pending: "bg-info text-dark", pending_approval: "bg-warning text-dark", inactive: "bg-secondary", completed: "bg-primary", self_assessed: "bg-info text-dark", approved_by_evaluator: "bg-primary", rejected: "bg-danger", draft: "bg-secondary" }; return classes[status] || "bg-light text-dark"; }
            formatDate(timestamp) { if (!timestamp) return "-"; return timestamp.toDate().toLocaleDateString('ja-JP'); }
        }

        // --- Start the App ---
        window.app = new App();
        window.app.init();
    </script>
</body>
</html>
