rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== Helper Functions =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }
    
    function isSameTenant(tenantId) {
      return isAuthenticated() && getUserData().tenantId == tenantId;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isActiveUser() {
      return isAuthenticated() && getUserData().status == 'active';
    }
    
    function isUserActiveInTenant(tenantId) {
      return isActiveUser() && isSameTenant(tenantId);
    }

    // ===== Users Collection =====
    match /users/{userId} {
      // 読み取り権限
      allow read: if isOwner(userId) 
                  || hasRole('developer') 
                  || (hasAnyRole(['admin', 'evaluator']) && isSameTenant(resource.data.tenantId));
      
      // 作成権限（開発者のみ、または招待による登録）
      allow create: if hasRole('developer') 
                    || (isAuthenticated() && request.auth.uid == userId);
      
      // 更新権限
      allow update: if hasRole('developer') 
                    || (hasRole('admin') && isSameTenant(resource.data.tenantId))
                    || (isOwner(userId) && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'updatedAt']));
      
      // 削除権限（開発者と管理者）
      allow delete: if hasRole('developer')
                    || (hasRole('admin') && isSameTenant(resource.data.tenantId));
    }
    
    // ===== Tenants Collection =====
    match /tenants/{tenantId} {
      allow read, write: if hasRole('developer');
      allow read: if hasRole('admin') && isSameTenant(tenantId);
      allow update: if hasRole('admin') && isSameTenant(tenantId) 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['companyName', 'updatedAt']);
    }
    
    // ===== Invitations Collection =====
    match /invitations/{invitationId} {
      // 読み取り（トークンベースの公開読み取り）
      allow read: if true;
      
      // 作成（管理者招待は開発者のみ、通常招待は管理者も可）
      allow create: if (hasRole('developer') && request.resource.data.type == 'admin')
                    || (hasRole('admin') && request.resource.data.type != 'admin' 
                        && request.resource.data.tenantId == getUserData().tenantId);
      
      // 更新（使用済みマークなど）
      allow update: if resource.data.used == false 
                    && request.resource.data.used == true
                    && request.resource.data.usedBy == request.auth.uid;
      
      // 削除（開発者と管理者）
      allow delete: if hasRole('developer')
                    || (hasRole('admin') && resource.data.tenantId == getUserData().tenantId);
    }
    
    // ===== Job Types Collection =====
    match /targetJobTypes/{jobTypeId} {
      // 読み取り（同一テナント内のアクティブユーザー）
      allow read: if isUserActiveInTenant(resource.data.tenantId);
      
      // 作成・更新・削除（同一テナントの管理者のみ）
      allow create: if hasRole('admin') && request.resource.data.tenantId == getUserData().tenantId;
      allow update: if hasRole('admin') && isSameTenant(resource.data.tenantId)
                    && request.resource.data.tenantId == resource.data.tenantId;
      allow delete: if hasRole('admin') && isSameTenant(resource.data.tenantId);
    }
    
    // ===== Evaluation Periods Collection =====
    match /evaluationPeriods/{periodId} {
      // 読み取り（同一テナント内のアクティブユーザー）
      allow read: if isUserActiveInTenant(resource.data.tenantId);
      
      // 作成・更新・削除（同一テナントの管理者のみ）
      allow create: if hasRole('admin') && request.resource.data.tenantId == getUserData().tenantId;
      allow update: if hasRole('admin') && isSameTenant(resource.data.tenantId)
                    && request.resource.data.tenantId == resource.data.tenantId;
      allow delete: if hasRole('admin') && isSameTenant(resource.data.tenantId);
    }
    
    // ===== Evaluation Structures Collection =====
    match /evaluationStructures/{structureId} {
      // 読み取り（同一テナント内のアクティブユーザー）
      allow read: if isUserActiveInTenant(resource.data.tenantId);
      
      // 作成・更新・削除（同一テナントの管理者のみ）
      allow create: if hasRole('admin') && request.resource.data.tenantId == getUserData().tenantId;
      allow update: if hasRole('admin') && isSameTenant(resource.data.tenantId)
                    && request.resource.data.tenantId == resource.data.tenantId;
      allow delete: if hasRole('admin') && isSameTenant(resource.data.tenantId);
    }
    
    // ===== Qualitative Goals Collection =====
    match /qualitativeGoals/{goalId} {
      // 読み取り（本人、管理者、評価者）
      allow read: if isOwner(resource.data.userId) 
                  || (hasRole('admin') && isSameTenant(resource.data.tenantId))
                  || (hasRole('evaluator') && isSameTenant(resource.data.tenantId));
      
      // 作成・更新（本人または管理者）
      allow create: if (isOwner(request.resource.data.userId) && isActiveUser())
                    || (hasRole('admin') && isSameTenant(request.resource.data.tenantId));
      
      allow update: if (isOwner(resource.data.userId) && isActiveUser()
                        && resource.data.status in ['draft', 'rejected'])
                    || (hasRole('admin') && isSameTenant(resource.data.tenantId));
      
      // 削除（管理者のみ）
      allow delete: if hasRole('admin') && isSameTenant(resource.data.tenantId);
    }
    
    // ===== Evaluations Collection =====
    match /evaluations/{evaluationId} {
      // 読み取り（評価対象者、評価者、管理者、開発者）
      allow read: if isOwner(resource.data.targetUserId) 
                  || isOwner(resource.data.evaluatorId)
                  || (hasRole('admin') && isSameTenant(resource.data.tenantId))
                  || hasRole('developer');
      
      // 作成（評価対象者、評価者、管理者）
      allow create: if (isOwner(request.resource.data.targetUserId) && isActiveUser())
                    || (isOwner(request.resource.data.evaluatorId) && isActiveUser())
                    || (hasRole('admin') && isSameTenant(request.resource.data.tenantId));
      
      // 更新（ステータスに応じた権限制御）
      allow update: if (isOwner(resource.data.targetUserId) && isActiveUser()
                        && resource.data.status in ['pending_submission', 'rejected'])
                    || (isOwner(resource.data.evaluatorId) && isActiveUser()
                        && resource.data.status in ['self_assessed', 'rejected'])
                    || (hasRole('admin') && isSameTenant(resource.data.tenantId));
      
      // 削除（管理者または開発者のみ）
      allow delete: if (hasRole('admin') && isSameTenant(resource.data.tenantId))
                    || hasRole('developer');
    }
    
    // ===== System Collections (開発者専用) =====
    match /systemSettings/{settingId} {
      allow read, write: if hasRole('developer');
    }
    
    match /auditLogs/{logId} {
      allow create: if isAuthenticated();
      allow read: if hasRole('developer')
                  || (hasRole('admin') && resource.data.tenantId == getUserData().tenantId);
      allow update, delete: if false;
    }
    
    // ===== Mail Collection (メール送信用) =====
    match /mail/{mailId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if false;
    }
    
    // ===== Additional Security Rules =====
    
    // バッチ操作の制限
    match /{document=**} {
      allow read, write: if false; // デフォルトで全拒否
    }
  }
}
